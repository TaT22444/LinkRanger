rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザーは自身のプロフィール情報のみ読み書き・削除できる
    // アカウント作成時のみ、自身のプロフィールを作成できる
    // 注意: subscriptionフィールドはサーバー側(Cloud Functions)のみ更新可能
    match /users/{userId} {
      allow read, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      // subscription情報以外の更新を許可
      allow update: if request.auth.uid == userId 
        && (!("subscription" in resource.data) || !("subscription" in request.resource.data) 
            || resource.data.subscription == request.resource.data.subscription);
    }

    // リンク、タグ、保存された分析結果
    // ログインしているユーザーは、自身のuserIdが記録されたドキュメントのみ、
    // 作成、読み取り、更新、削除ができる
    match /links/{linkId} {
      allow read, update, delete: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }

    match /tags/{tagId} {
      allow read, update, delete: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }

    match /savedAnalyses/{analysisId} {
      allow read, update, delete: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }

    // AI使用量データ（サーバー管理、読み取り専用）
    match /aiUsage/{usageId} {
      // 自分の使用量のみ読み取り可能（アカウント画面での表示用）
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // 書き込みはCloud Functionsのみ
      allow write: if false;
    }
    
    match /aiUsageSummary/{summaryId} {
      // 自分のサマリーのみ読み取り可能（summaryIdは "userId_YYYY-MM" 形式）
      allow read: if request.auth != null && summaryId.matches(request.auth.uid + '_.*');
      // 書き込みはCloud Functionsのみ
      allow write: if false;
    }
    // タグキャッシュ（全ユーザー共通、パフォーマンス最適化用）
    match /tagCache/{cacheId} {
      // 認証済みユーザーは読み取り可能
      allow read: if request.auth != null;
      // 書き込みはCloud Functionsのみ
      allow write: if false;
    }
  }
}