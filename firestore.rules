rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰€æœ‰è€…ã‹ã‚’ç¢ºèª (ä½œæˆæ™‚)
    function isCreatingOwner() {
      return request.auth.uid == request.resource.data.userId;
    }
    
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰€æœ‰è€…ã‹ã‚’ç¢ºèª (æ›´æ–°ãƒ»å‰Šé™¤æ™‚)
    function isUpdatingOwner() {
      return request.auth.uid == resource.data.userId;
    }
    
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function documentExists() {
      return resource != null;
    }

    // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: æ–‡å­—åˆ—é•·åˆ¶é™
    function isValidStringLength(value, maxLength) {
      return value is string && value.size() <= maxLength;
    }

    // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: URLå½¢å¼ãƒã‚§ãƒƒã‚¯
    function isValidUrl(url) {
      return url is string && 
             url.size() > 0 && 
             url.size() <= 2000 && 
             (url.matches('https://.*') || url.matches('http://.*'));
    }

    // ğŸ”’ ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email in [
               'tatsu0823takasago@icloud.com'
             ];
    }

    // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
    function isValidLinkData(data) {
      return data.keys().hasAll(['userId', 'url', 'title']) &&
             isValidStringLength(data.title, 500) &&
             isValidUrl(data.url) &&
             data.userId is string;
    }

    // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
    function isValidTagData(data) {
      return data.keys().hasAll(['userId', 'name']) &&
             isValidStringLength(data.name, 50) &&
             data.userId is string;
    }

    // --- User Profiles ---
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    match /users/{userId} {
      allow read, delete: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;

      // ğŸ”’ æ›´æ–°ãƒ«ãƒ¼ãƒ«: æ¨©é™ãƒã‚§ãƒƒã‚¯ + ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      allow update: if isSignedIn() && 
                       request.auth.uid == userId &&
                       // é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ”¹ã–ã‚“é˜²æ­¢
                       (!('uid' in request.resource.data) || request.resource.data.uid == userId) &&
                       (!('email' in request.resource.data) || request.resource.data.email == request.auth.token.email);
    }

    // --- User-Owned Content (Links, Tags, Analyses) ---
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªèº«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿ä½œæˆãƒ»èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãŒå¯èƒ½
    match /links/{linkId} {
      allow read, delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner() && 
                       // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                       isValidLinkData(request.resource.data);
    }

    match /tags/{tagId} {
      allow read, delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner() && 
                       // ğŸ”’ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                       isValidTagData(request.resource.data);
    }

    match /folders/{folderId} {
      allow read, delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner();
    }

    match /searchHistory/{historyId} {
      allow read, delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner();
    }

    match /appSettings/{settingId} {
      allow read: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner();
    }

    match /savedAnalyses/{analysisId} {
      allow read, delete: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin());
      allow update: if isSignedIn() && documentExists() && (isUpdatingOwner() || isAdmin()) &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner();
    }

    // --- Server-Managed Collections ---
    // AIä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã®ã¿è¨±å¯ã€‚
    match /aiUsage/{usageId} {
      // è‡ªåˆ†ã®ä½¿ç”¨é‡ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if isSignedIn() && documentExists() && isUpdatingOwner();
      allow write: if false; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã¯å…¨é¢ç¦æ­¢
    }
    
    // AIä½¿ç”¨é‡ã®æœˆæ¬¡ã‚µãƒãƒªãƒ¼ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã®ã¿è¨±å¯ã€‚
    match /aiUsageSummary/{summaryId} {
      // è‡ªåˆ†ã®ã‚µãƒãƒªãƒ¼ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½ (summaryIdã¯ "userId_YYYY-MM" å½¢å¼)
      allow read: if isSignedIn() && summaryId.matches(request.auth.uid + '_.*');
      allow write: if false; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã¯å…¨é¢ç¦æ­¢
    }

    // ã‚¿ã‚°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚èª­ã¿å–ã‚Šå°‚ç”¨ã€‚
    match /tagCache/{cacheId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if isSignedIn();
      allow write: if false; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã¯å…¨é¢ç¦æ­¢
    }

    // --- ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ ---
    // ãŠçŸ¥ã‚‰ã›ã€‚ã™ã¹ã¦ã®èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Šå¯èƒ½ã€‚
    match /announcements/{announcementId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if isSignedIn();
      // ç®¡ç†è€…ã®ã¿æ›¸ãè¾¼ã¿å¯èƒ½
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ãŠçŸ¥ã‚‰ã›æ—¢èª­çŠ¶æ…‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªèº«ã®æ—¢èª­æƒ…å ±ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚
    match /userAnnouncementReads/{readId} {
      allow read, delete: if isSignedIn() && documentExists() && isUpdatingOwner();
      allow update: if isSignedIn() && documentExists() && isUpdatingOwner() &&
                       // ğŸ”’ userIdæ”¹ã–ã‚“é˜²æ­¢
                       request.resource.data.userId == resource.data.userId;
      allow create: if isSignedIn() && isCreatingOwner();
    }
  }
}